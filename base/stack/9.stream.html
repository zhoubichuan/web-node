<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>九.Stream | Node学习笔记</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="个人总结的vuepress学习技术文档-语法">
    <meta name="keywords" content="vuepress,最新技术文档,vuepress语法,markdown语法">
    
    <link rel="preload" href="/web-node/assets/css/0.styles.a3842ab0.css" as="style"><link rel="preload" href="/web-node/assets/js/app.3aff489a.js" as="script"><link rel="preload" href="/web-node/assets/js/2.8ac8e006.js" as="script"><link rel="preload" href="/web-node/assets/js/52.5e6a67e8.js" as="script"><link rel="preload" href="/web-node/assets/js/6.64657bde.js" as="script"><link rel="prefetch" href="/web-node/assets/js/10.18a3bfa7.js"><link rel="prefetch" href="/web-node/assets/js/11.8e3f0642.js"><link rel="prefetch" href="/web-node/assets/js/12.355bc80d.js"><link rel="prefetch" href="/web-node/assets/js/13.fc0f3e4a.js"><link rel="prefetch" href="/web-node/assets/js/14.0a0a8d87.js"><link rel="prefetch" href="/web-node/assets/js/15.c5491206.js"><link rel="prefetch" href="/web-node/assets/js/16.9ed5cc92.js"><link rel="prefetch" href="/web-node/assets/js/17.916ac063.js"><link rel="prefetch" href="/web-node/assets/js/18.c9b03d9c.js"><link rel="prefetch" href="/web-node/assets/js/19.a774cd53.js"><link rel="prefetch" href="/web-node/assets/js/20.62247d3e.js"><link rel="prefetch" href="/web-node/assets/js/21.6ab97afe.js"><link rel="prefetch" href="/web-node/assets/js/22.fdce669a.js"><link rel="prefetch" href="/web-node/assets/js/23.236477c2.js"><link rel="prefetch" href="/web-node/assets/js/24.e98adaf9.js"><link rel="prefetch" href="/web-node/assets/js/25.5aa470ac.js"><link rel="prefetch" href="/web-node/assets/js/26.effa7771.js"><link rel="prefetch" href="/web-node/assets/js/27.175efcc4.js"><link rel="prefetch" href="/web-node/assets/js/28.b611c32a.js"><link rel="prefetch" href="/web-node/assets/js/29.0e3f3102.js"><link rel="prefetch" href="/web-node/assets/js/3.b185f933.js"><link rel="prefetch" href="/web-node/assets/js/30.2972c7d5.js"><link rel="prefetch" href="/web-node/assets/js/31.2cbc655f.js"><link rel="prefetch" href="/web-node/assets/js/32.dffac303.js"><link rel="prefetch" href="/web-node/assets/js/33.48b9765d.js"><link rel="prefetch" href="/web-node/assets/js/34.71888d6c.js"><link rel="prefetch" href="/web-node/assets/js/35.c0d73207.js"><link rel="prefetch" href="/web-node/assets/js/36.f719d135.js"><link rel="prefetch" href="/web-node/assets/js/37.97031b98.js"><link rel="prefetch" href="/web-node/assets/js/38.33d190e4.js"><link rel="prefetch" href="/web-node/assets/js/39.2b0ba82e.js"><link rel="prefetch" href="/web-node/assets/js/4.81b8ed13.js"><link rel="prefetch" href="/web-node/assets/js/40.385831cb.js"><link rel="prefetch" href="/web-node/assets/js/41.64a46cb9.js"><link rel="prefetch" href="/web-node/assets/js/42.e2086ade.js"><link rel="prefetch" href="/web-node/assets/js/43.c41555ce.js"><link rel="prefetch" href="/web-node/assets/js/44.c7713db7.js"><link rel="prefetch" href="/web-node/assets/js/45.b3f18120.js"><link rel="prefetch" href="/web-node/assets/js/46.15d2899c.js"><link rel="prefetch" href="/web-node/assets/js/47.00ee6a7e.js"><link rel="prefetch" href="/web-node/assets/js/48.28c32dec.js"><link rel="prefetch" href="/web-node/assets/js/49.cbe8a16d.js"><link rel="prefetch" href="/web-node/assets/js/5.651c3654.js"><link rel="prefetch" href="/web-node/assets/js/50.6ac55cd0.js"><link rel="prefetch" href="/web-node/assets/js/51.0fd45888.js"><link rel="prefetch" href="/web-node/assets/js/53.2ead3d13.js"><link rel="prefetch" href="/web-node/assets/js/54.2937351a.js"><link rel="prefetch" href="/web-node/assets/js/55.ed779fd3.js"><link rel="prefetch" href="/web-node/assets/js/56.9f67ccd8.js"><link rel="prefetch" href="/web-node/assets/js/57.710047a7.js"><link rel="prefetch" href="/web-node/assets/js/58.c7018ae9.js"><link rel="prefetch" href="/web-node/assets/js/59.7143e144.js"><link rel="prefetch" href="/web-node/assets/js/60.3821df2b.js"><link rel="prefetch" href="/web-node/assets/js/61.b95034dd.js"><link rel="prefetch" href="/web-node/assets/js/62.c79a6f63.js"><link rel="prefetch" href="/web-node/assets/js/63.49e08895.js"><link rel="prefetch" href="/web-node/assets/js/64.a0502a89.js"><link rel="prefetch" href="/web-node/assets/js/65.44b687fe.js"><link rel="prefetch" href="/web-node/assets/js/66.aba86d11.js"><link rel="prefetch" href="/web-node/assets/js/67.50788f22.js"><link rel="prefetch" href="/web-node/assets/js/68.3ffce65c.js"><link rel="prefetch" href="/web-node/assets/js/69.fc86c65a.js"><link rel="prefetch" href="/web-node/assets/js/7.261f4774.js"><link rel="prefetch" href="/web-node/assets/js/70.5f9aa35a.js"><link rel="prefetch" href="/web-node/assets/js/71.1ed8b35d.js"><link rel="prefetch" href="/web-node/assets/js/72.d9baaaed.js"><link rel="prefetch" href="/web-node/assets/js/73.587a29ee.js"><link rel="prefetch" href="/web-node/assets/js/74.01c7edc4.js"><link rel="prefetch" href="/web-node/assets/js/75.e08e646f.js"><link rel="prefetch" href="/web-node/assets/js/76.e30ca7ad.js"><link rel="prefetch" href="/web-node/assets/js/77.92292afd.js"><link rel="prefetch" href="/web-node/assets/js/78.f4346d46.js"><link rel="prefetch" href="/web-node/assets/js/79.44722955.js"><link rel="prefetch" href="/web-node/assets/js/8.a76811ee.js"><link rel="prefetch" href="/web-node/assets/js/80.5f83e4d0.js"><link rel="prefetch" href="/web-node/assets/js/81.610faf13.js"><link rel="prefetch" href="/web-node/assets/js/82.18da7db3.js"><link rel="prefetch" href="/web-node/assets/js/83.d6154f3a.js"><link rel="prefetch" href="/web-node/assets/js/84.939e396f.js"><link rel="prefetch" href="/web-node/assets/js/85.e74a2ce1.js"><link rel="prefetch" href="/web-node/assets/js/86.3b387324.js"><link rel="prefetch" href="/web-node/assets/js/87.9246d1da.js"><link rel="prefetch" href="/web-node/assets/js/88.883d97f5.js"><link rel="prefetch" href="/web-node/assets/js/89.eecaa70f.js"><link rel="prefetch" href="/web-node/assets/js/9.73a453f4.js"><link rel="prefetch" href="/web-node/assets/js/90.c19cc61c.js"><link rel="prefetch" href="/web-node/assets/js/91.09745672.js"><link rel="prefetch" href="/web-node/assets/js/92.17ad9d83.js"><link rel="prefetch" href="/web-node/assets/js/93.50a082ed.js"><link rel="prefetch" href="/web-node/assets/js/94.6c43ded5.js"><link rel="prefetch" href="/web-node/assets/js/95.2a295ab5.js"><link rel="prefetch" href="/web-node/assets/js/96.b35ffade.js">
    <link rel="stylesheet" href="/web-node/assets/css/0.styles.a3842ab0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/web-node/" class="home-link router-link-active"><!----> <span class="site-name">Node学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础知识" class="dropdown-title"><span class="title">基础知识</span> <span class="arrow down"></span></button> <button type="button" aria-label="基础知识" class="mobile-dropdown-title"><span class="title">基础知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-node/base/stack/1.node.html" class="nav-link">
  一.node基础
</a></li><li class="dropdown-item"><!----> <a href="/web-node/base/oop/1.objectOriented.html" class="nav-link">
  二.简单案例
</a></li><li class="dropdown-item"><!----> <a href="/web-node/base/3.browser/1.browser.html" class="nav-link">
  三.浏览器渲染机制
</a></li><li class="dropdown-item"><!----> <a href="/web-node/base/dom/1.event.html" class="nav-link">
  四.DOM事件及设计模式
</a></li><li class="dropdown-item"><!----> <a href="/web-node/base/es6/1.let.html" class="nav-link">
  五.ES6+核心源码分析
</a></li><li class="dropdown-item"><!----> <a href="/web-node/base/websocket/1.index.html" class="nav-link">
  六.websocket
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="高级知识" class="dropdown-title"><span class="title">高级知识</span> <span class="arrow down"></span></button> <button type="button" aria-label="高级知识" class="mobile-dropdown-title"><span class="title">高级知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-node/senior/http/1.http.html" class="nav-link">
  一.计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/web-node/senior/network/1.network.html" class="nav-link">
  二.登陆相关
</a></li><li class="dropdown-item"><!----> <a href="/web-node/senior/cookie/1.cookie.html" class="nav-link">
  三.后端监控
</a></li><li class="dropdown-item"><!----> <a href="/web-node/senior/security/1.index.html" class="nav-link">
  四.安全防范
</a></li><li class="dropdown-item"><!----> <a href="/web-node/senior/serverless/1.index.html" class="nav-link">
  五.Serverless
</a></li><li class="dropdown-item"><!----> <a href="/web-node/senior/graphql/1.index.html" class="nav-link">
  六.GraphQL
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="阅读书籍" class="dropdown-title"><span class="title">阅读书籍</span> <span class="arrow down"></span></button> <button type="button" aria-label="阅读书籍" class="mobile-dropdown-title"><span class="title">阅读书籍</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-node/read/book1/1.preparation.html" class="nav-link">
  一.Node.js 开发指南
</a></li><li class="dropdown-item"><!----> <a href="/web-node/read/book2/1.preparation.html" class="nav-link">
  二.了不起的 Node.js
</a></li><li class="dropdown-item"><!----> <a href="/web-node/read/book3/1.preparation.html" class="nav-link">
  三.Node.js 实战
</a></li><li class="dropdown-item"><!----> <a href="/web-node/read/book4/1.preparation.html" class="nav-link">
  四.深入浅出 Node.js
</a></li></ul></div></div> <a href="https://github.com/zhoubichuan/web-node" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础知识" class="dropdown-title"><span class="title">基础知识</span> <span class="arrow down"></span></button> <button type="button" aria-label="基础知识" class="mobile-dropdown-title"><span class="title">基础知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-node/base/stack/1.node.html" class="nav-link">
  一.node基础
</a></li><li class="dropdown-item"><!----> <a href="/web-node/base/oop/1.objectOriented.html" class="nav-link">
  二.简单案例
</a></li><li class="dropdown-item"><!----> <a href="/web-node/base/3.browser/1.browser.html" class="nav-link">
  三.浏览器渲染机制
</a></li><li class="dropdown-item"><!----> <a href="/web-node/base/dom/1.event.html" class="nav-link">
  四.DOM事件及设计模式
</a></li><li class="dropdown-item"><!----> <a href="/web-node/base/es6/1.let.html" class="nav-link">
  五.ES6+核心源码分析
</a></li><li class="dropdown-item"><!----> <a href="/web-node/base/websocket/1.index.html" class="nav-link">
  六.websocket
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="高级知识" class="dropdown-title"><span class="title">高级知识</span> <span class="arrow down"></span></button> <button type="button" aria-label="高级知识" class="mobile-dropdown-title"><span class="title">高级知识</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-node/senior/http/1.http.html" class="nav-link">
  一.计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/web-node/senior/network/1.network.html" class="nav-link">
  二.登陆相关
</a></li><li class="dropdown-item"><!----> <a href="/web-node/senior/cookie/1.cookie.html" class="nav-link">
  三.后端监控
</a></li><li class="dropdown-item"><!----> <a href="/web-node/senior/security/1.index.html" class="nav-link">
  四.安全防范
</a></li><li class="dropdown-item"><!----> <a href="/web-node/senior/serverless/1.index.html" class="nav-link">
  五.Serverless
</a></li><li class="dropdown-item"><!----> <a href="/web-node/senior/graphql/1.index.html" class="nav-link">
  六.GraphQL
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="阅读书籍" class="dropdown-title"><span class="title">阅读书籍</span> <span class="arrow down"></span></button> <button type="button" aria-label="阅读书籍" class="mobile-dropdown-title"><span class="title">阅读书籍</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web-node/read/book1/1.preparation.html" class="nav-link">
  一.Node.js 开发指南
</a></li><li class="dropdown-item"><!----> <a href="/web-node/read/book2/1.preparation.html" class="nav-link">
  二.了不起的 Node.js
</a></li><li class="dropdown-item"><!----> <a href="/web-node/read/book3/1.preparation.html" class="nav-link">
  三.Node.js 实战
</a></li><li class="dropdown-item"><!----> <a href="/web-node/read/book4/1.preparation.html" class="nav-link">
  四.深入浅出 Node.js
</a></li></ul></div></div> <a href="https://github.com/zhoubichuan/web-node" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/web-node/base/stack/1.node.html" class="sidebar-link">一.Node 安装</a></li><li><a href="/web-node/base/stack/2.install.html" class="sidebar-link">二.Node介绍</a></li><li><a href="/web-node/base/stack/3.repl.html" class="sidebar-link">三.REPL</a></li><li><a href="/web-node/base/stack/4.core.html" class="sidebar-link">四.core</a></li><li><a href="/web-node/base/stack/5.module.html" class="sidebar-link">五.module 和 npm</a></li><li><a href="/web-node/base/stack/6.encoding.html" class="sidebar-link">六.Encoding</a></li><li><a href="/web-node/base/stack/7.buffer.html" class="sidebar-link">七.buffer</a></li><li><a href="/web-node/base/stack/8.fs.html" class="sidebar-link">八.fs</a></li><li><a href="/web-node/base/stack/9.stream.html" aria-current="page" class="active sidebar-link">九.Stream</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_1-流的概念" class="sidebar-link">1.流的概念</a></li><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_2-可读流-createreadstream" class="sidebar-link">2.可读流 createReadStream</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_2-1-创建可读流" class="sidebar-link">2.1 创建可读流</a></li><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_2-2-监听-data-事件" class="sidebar-link">2.2 监听 data 事件</a></li><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_2-3-监听-end-事件" class="sidebar-link">2.3 监听 end 事件</a></li><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_2-4-监听-error-事件" class="sidebar-link">2.4 监听 error 事件</a></li><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_2-5-监听-open-事件" class="sidebar-link">2.5 监听 open 事件</a></li><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_2-6-监听-close-事件" class="sidebar-link">2.6 监听 close 事件</a></li><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_2-7-设置编码" class="sidebar-link">2.7 设置编码</a></li><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_2-8-暂停和恢复触发-data" class="sidebar-link">2.8 暂停和恢复触发 data</a></li></ul></li><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_3-可写流-createwritestream" class="sidebar-link">3.可写流 createWriteStream</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_3-1-创建可写流" class="sidebar-link">3.1 创建可写流</a></li><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_3-2-write-方法" class="sidebar-link">3.2 write 方法</a></li><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_3-3-end-方法" class="sidebar-link">3.3 end 方法</a></li><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_3-4-drain-方法" class="sidebar-link">3.4 drain 方法</a></li><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_3-5-finish-方法" class="sidebar-link">3.5 finish 方法</a></li></ul></li><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_4-pipe-方法" class="sidebar-link">4.pipe 方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_4-1-pipe-方法的原理" class="sidebar-link">4.1 pipe 方法的原理</a></li><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_4-2-pipt-用法" class="sidebar-link">4.2 pipt 用法</a></li><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_4-3-unpipe-用法" class="sidebar-link">4.3 unpipe 用法</a></li><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_4-4-cork" class="sidebar-link">4.4 cork</a></li><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_4-5-uncork" class="sidebar-link">4.5 uncork</a></li></ul></li><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_5-简单实现" class="sidebar-link">5.简单实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_5-1-可读流的简单实现" class="sidebar-link">5.1 可读流的简单实现</a></li></ul></li><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_5-2-可写流的简单实现" class="sidebar-link">5.2 可写流的简单实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_5-3-pipe" class="sidebar-link">5.3 pipe</a></li><li class="sidebar-sub-header"><a href="/web-node/base/stack/9.stream.html#_5-4-暂停模式" class="sidebar-link">5.4 暂停模式</a></li></ul></li></ul></li><li><a href="/web-node/base/stack/10.cache.html" class="sidebar-link">十.cache</a></li><li><a href="/web-node/base/stack/11.tcp.html" class="sidebar-link">十一.tcp</a></li><li><a href="/web-node/base/stack/12.yargs.html" class="sidebar-link">十二.yargs</a></li><li><a href="/web-node/base/stack/13.compress.html" class="sidebar-link">十三.compress</a></li><li><a href="/web-node/base/stack/14.crypto.html" class="sidebar-link">十四.crypto</a></li><li><a href="/web-node/base/stack/15.process.html" class="sidebar-link">十五.process</a></li><li><a href="/web-node/base/stack/16.action.html" class="sidebar-link">十六.action</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="九-stream"><a href="#九-stream" class="header-anchor">#</a> 九.Stream</h1> <h2 id="_1-流的概念"><a href="#_1-流的概念" class="header-anchor">#</a> 1.流的概念</h2> <ul><li>流是一组有序的，有起点和终点的字节数据传输手段</li> <li>它不关心文件的整体内容，只关注是否从文件中读到了数据，以及读到数据之后的处理</li> <li>流是一个抽象接口，被 Node 中的很多对象所实现。比如 HTTP 服务器 request 和 response 对象都是流</li></ul> <h2 id="_2-可读流-createreadstream"><a href="#_2-可读流-createreadstream" class="header-anchor">#</a> 2.可读流 createReadStream</h2> <p>实现了<code>stream.Readable</code>接口的对象，将对象数据读取为流数据，当监听 data 事件后，开始发射数据</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>fs<span class="token punctuation">.</span><span class="token function-variable function">createReadStream</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReadStream</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
utils<span class="token punctuation">.</span><span class="token function">inherits</span><span class="token punctuation">(</span>ReadStream<span class="token punctuation">,</span> Readable<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_2-1-创建可读流"><a href="#_2-1-创建可读流" class="header-anchor">#</a> 2.1 创建可读流</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><p>1.path 读取文件的路径</p></li> <li><ol start="2"><li>options</li></ol> <ul><li>flags 打开文件要做的操作，默认为<code>r</code></li> <li>encoding 默认为 null</li> <li>start 开始读取的索引位置</li> <li>end 结束肚脐的索引位置</li> <li>highWaterMark 读取缓存区默认的大小 64kb</li></ul></li></ul> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>如果指定 utf8 编码 highWaterMark 要大于 3 个字节</p></div> <h3 id="_2-2-监听-data-事件"><a href="#_2-2-监听-data-事件" class="header-anchor">#</a> 2.2 监听 data 事件</h3> <p>流切换到流动模式，数据会被尽可能快的读出</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_2-3-监听-end-事件"><a href="#_2-3-监听-end-事件" class="header-anchor">#</a> 2.3 监听 end 事件</h3> <p>该事件会在读完数据后被触发</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;读取完成&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_2-4-监听-error-事件"><a href="#_2-4-监听-error-事件" class="header-anchor">#</a> 2.4 监听 error 事件</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_2-5-监听-open-事件"><a href="#_2-5-监听-open-事件" class="header-anchor">#</a> 2.5 监听 open 事件</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_2-6-监听-close-事件"><a href="#_2-6-监听-close-事件" class="header-anchor">#</a> 2.6 监听 close 事件</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="_2-7-设置编码"><a href="#_2-7-设置编码" class="header-anchor">#</a> 2.7 设置编码</h3> <p>与指定{encoding:'utf8'}效果相同，设置编码</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>rs<span class="token punctuation">.</span><span class="token function">setEncoding</span><span class="token punctuation">(</span><span class="token string">&quot;utf8&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_2-8-暂停和恢复触发-data"><a href="#_2-8-暂停和恢复触发-data" class="header-anchor">#</a> 2.8 暂停和恢复触发 data</h3> <p>通过 pause()方法和 resume()方法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rs<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rs<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="_3-可写流-createwritestream"><a href="#_3-可写流-createwritestream" class="header-anchor">#</a> 3.可写流 createWriteStream</h2> <p>实现了 stream.Writable 接口的对象将流数据写入到对象中</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>fs<span class="token punctuation">.</span><span class="token function-variable function">createWriteStream</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WriteStream</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
util<span class="token punctuation">.</span><span class="token function">inherits</span><span class="token punctuation">(</span>WriteStream<span class="token punctuation">,</span> Writable<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_3-1-创建可写流"><a href="#_3-1-创建可写流" class="header-anchor">#</a> 3.1 创建可写流</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> ws <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>1.path 写入的文件路径</li> <li>2.options
<ul><li>flags 打开文件要做的操作，默认为<code>w</code></li> <li>encoding 默认为 utf8</li> <li>highWaterMark 写入缓存区的默认大小 16kb</li></ul></li></ul> <h3 id="_3-2-write-方法"><a href="#_3-2-write-方法" class="header-anchor">#</a> 3.2 write 方法</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> <span class="token punctuation">[</span>encoding<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>1.chunk 写入的数据 buffer/string</li> <li>2.encoding 编码格式 chunk 为字符串时有用，可选</li> <li>3.callback 写入成功后的回调
<blockquote><p>返回值为布尔值，系统缓存区满时为 false,未满时为 true</p></blockquote></li></ul> <h3 id="_3-3-end-方法"><a href="#_3-3-end-方法" class="header-anchor">#</a> 3.3 end 方法</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ws<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> <span class="token punctuation">[</span>encoding<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>callback<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>表明接下来没有数据要被写入 writable 通过传入可选的 chunk 和 encoding 参数，可以在关闭流之前再写入一段数据，如果传入了可选的 callback 函数，它将作为<code>finish</code>事件的回调函数</p></blockquote> <h3 id="_3-4-drain-方法"><a href="#_3-4-drain-方法" class="header-anchor">#</a> 3.4 drain 方法</h3> <ul><li>当一个流不处在 drain 的状态，对 write()的调用会缓存数据块，并且返回 false。一旦所有当前缓存的数据都排空了（被操作系统接受来进行输出），那么<code>drain</code>事件就会被触发</li> <li>建议，一旦 write() 返回 false，在<code>drain</code>事件触发前，不能写入任何数据块</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> ws <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">.</span>txt<span class="token punctuation">,</span><span class="token punctuation">{</span>
  <span class="token literal-property property">flags</span><span class="token operator">:</span><span class="token string">'w'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">encoding</span><span class="token operator">:</span><span class="token string">'utf8'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">highWaterMark</span><span class="token operator">:</span><span class="token number">3</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">10</span>
<span class="token keyword">function</span> <span class="token function">wrire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>i <span class="token operator">&amp;&amp;</span> flag<span class="token punctuation">)</span><span class="token punctuation">{</span>
    flag <span class="token operator">=</span> ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
    i<span class="token operator">--</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'drain'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'drain'</span><span class="token punctuation">)</span>
    <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="_3-5-finish-方法"><a href="#_3-5-finish-方法" class="header-anchor">#</a> 3.5 finish 方法</h3> <p>在调用了 stream.end()方法，且缓冲区数据都已经传给底层系统之后，'finish'事件将被触发。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> write <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">&quot;./2.txt&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
writer<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">&quot;结束\n&quot;</span><span class="token punctuation">)</span>
writer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;finish&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;所有的写入已经完成!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="_4-pipe-方法"><a href="#_4-pipe-方法" class="header-anchor">#</a> 4.pipe 方法</h2> <h3 id="_4-1-pipe-方法的原理"><a href="#_4-1-pipe-方法的原理" class="header-anchor">#</a> 4.1 pipe 方法的原理</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> ws <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">&quot;./2.txt&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">&quot;./1.txt&quot;</span><span class="token punctuation">)</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> flag <span class="token operator">=</span> ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span> rs<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;drain&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rs<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ws<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_4-2-pipt-用法"><a href="#_4-2-pipt-用法" class="header-anchor">#</a> 4.2 pipt 用法</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// readStream.pipe(writeStream)</span>
<span class="token keyword">var</span> from <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">&quot;./1.txt&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> to <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">&quot;./2.txt&quot;</span><span class="token punctuation">)</span>
from<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>将数据的滞留量限制到一个可接受的水平，以使得不同速度的来源和目标不会淹没可用内存</p></blockquote> <h3 id="_4-3-unpipe-用法"><a href="#_4-3-unpipe-用法" class="header-anchor">#</a> 4.3 unpipe 用法</h3> <ul><li>readable.unpipe()方法将之前通过 stream.pipe()方法绑定的流分离</li> <li>如果 destination 没有传入,则所有绑定的流都会被分离</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> from <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">&quot;./1.txt&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> to <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">&quot;./2.txt&quot;</span><span class="token punctuation">)</span>
from<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;关闭向2.txt的写入&quot;</span><span class="token punctuation">)</span>
  from<span class="token punctuation">.</span><span class="token function">unpipe</span><span class="token punctuation">(</span>writable<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;手工关闭文件流&quot;</span><span class="token punctuation">)</span>
  to<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_4-4-cork"><a href="#_4-4-cork" class="header-anchor">#</a> 4.4 cork</h3> <p>调用 writable.cork()方法将强制所有写入数据都存放到内存中的缓冲区里。直到调用<code>stream.uncork()</code>或<code>stream.end()</code>方法时，缓冲区里的数据才会被输出。</p> <h3 id="_4-5-uncork"><a href="#_4-5-uncork" class="header-anchor">#</a> 4.5 uncork</h3> <p><code>writable.uncork()</code>将输出在<code>stream.cork()</code>方法被调用之后缓冲在内存中的所有数据</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>stream<span class="token punctuation">.</span><span class="token function">cork</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
stream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span>
stream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> stream<span class="token punctuation">.</span><span class="token function">uncork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="_5-简单实现"><a href="#_5-简单实现" class="header-anchor">#</a> 5.简单实现</h2> <h3 id="_5-1-可读流的简单实现"><a href="#_5-1-可读流的简单实现" class="header-anchor">#</a> 5.1 可读流的简单实现</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> ReadStream <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./ReadStream'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> rs <span class="token operator">=</span> <span class="token function">ReadStream</span><span class="token punctuation">(</span><span class="token string">'./1.txt'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
  <span class="token literal-property property">flags</span><span class="token operator">:</span><span class="token string">'r'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">encoding</span><span class="token operator">:</span><span class="token string">'utf8'</span><span class="token punctuation">.</span>
  <span class="token literal-property property">start</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token literal-property property">end</span><span class="token operator">:</span><span class="token number">7</span><span class="token punctuation">,</span>
  <span class="token literal-property property">highWaterMark</span><span class="token operator">:</span><span class="token number">3</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;events&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">WriteStream</span> <span class="token keyword">extends</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> path
    <span class="token keyword">this</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> options<span class="token punctuation">.</span>fd
    <span class="token keyword">this</span><span class="token punctuation">.</span>flags <span class="token operator">=</span> options<span class="token punctuation">.</span>flags <span class="token operator">||</span> <span class="token string">&quot;r&quot;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>encoding <span class="token operator">=</span> options<span class="token punctuation">.</span>encoding
    <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> options<span class="token punctuation">.</span>start <span class="token operator">||</span> <span class="token number">0</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>start
    <span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">=</span> options<span class="token punctuation">.</span>end
    <span class="token keyword">this</span><span class="token punctuation">.</span>flowing <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>autoClose <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark <span class="token operator">=</span> options<span class="token punctuation">.</span>highWaterMark <span class="token operator">||</span> <span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>buffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;newListener&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> listener</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token string">&quot;data&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>flowing <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>autoClose<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fd <span class="token operator">!=</span> <span class="token string">&quot;number&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> n <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>end
      <span class="token operator">?</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pos<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark
    fs<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pos<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> bytesRead</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> bytesRead<span class="token punctuation">)</span>
        data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>encoding <span class="token operator">?</span> data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>encoding<span class="token punctuation">)</span> <span class="token operator">:</span> data
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">+=</span> bytesRead
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>flowing<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flags<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mode<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> fd</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> fd
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>autoClose<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> WriteStream
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br></div></div><h2 id="_5-2-可写流的简单实现"><a href="#_5-2-可写流的简单实现" class="header-anchor">#</a> 5.2 可写流的简单实现</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> FileWriteStream <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./FileWriteStream&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> ws <span class="token operator">=</span> <span class="token function">FileWriteStream</span><span class="token punctuation">(</span><span class="token string">&quot;./2.txt&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">flags</span><span class="token operator">:</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">&quot;utf8&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">highWaterMark</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">10</span>
<span class="token keyword">function</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&amp;&amp;</span> flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    flag <span class="token operator">=</span> ws<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>
      <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;utf8&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    i<span class="token operator">--</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;drain&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;drain&quot;</span><span class="token punctuation">)</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;events&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">WriteStream</span> <span class="token keyword">extends</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>path <span class="token operator">=</span> path
    <span class="token keyword">this</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> options<span class="token punctuation">.</span>fd
    <span class="token keyword">this</span><span class="token punctuation">.</span>flags <span class="token operator">=</span> options<span class="token punctuation">.</span>flags <span class="token operator">||</span> <span class="token string">&quot;w&quot;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> options<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token number">0o666</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>encoding <span class="token operator">=</span> options<span class="token punctuation">.</span>encoding
    <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> options<span class="token punctuation">.</span>start <span class="token operator">||</span> <span class="token number">0</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>start
    <span class="token keyword">this</span><span class="token punctuation">.</span>writing <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>autoClose <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark <span class="token operator">=</span> options<span class="token punctuation">.</span>highWaterMark <span class="token operator">||</span> <span class="token number">16</span> <span class="token operator">*</span> <span class="token number">1024</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>buffers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flags<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mode<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> fd</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> fd
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">write</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> encoding <span class="token operator">==</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cb <span class="token operator">=</span> encoding
      encoding <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>

    chunk <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">isBuffer</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
      <span class="token operator">?</span> chunk
      <span class="token operator">:</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>encoding <span class="token operator">||</span> <span class="token string">&quot;utf8&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> len <span class="token operator">=</span> chunk<span class="token punctuation">.</span>length
    <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">+=</span> len
    <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>highWaterMark
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>writing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>buffers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        chunk<span class="token punctuation">,</span>
        encoding<span class="token punctuation">,</span>
        cb<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>writing <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_write</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">clearBuffer</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret
  <span class="token punctuation">}</span>

  <span class="token function">_write</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fd <span class="token operator">!=</span> <span class="token string">&quot;number&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">&quot;open&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_write</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    fs<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span> chunk<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> chunk<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pos<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> written</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>autoClose<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">-=</span> written
      <span class="token keyword">this</span><span class="token punctuation">.</span>pos <span class="token operator">+=</span> written
      cb <span class="token operator">&amp;&amp;</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">clearBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buffers<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_write</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>chunk<span class="token punctuation">,</span> data<span class="token punctuation">.</span>encoding<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">clearBuffer</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>writing <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;drain&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>autoClose<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;close&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> WriteStream
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br></div></div><h3 id="_5-3-pipe"><a href="#_5-3-pipe" class="header-anchor">#</a> 5.3 pipe</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> ReadStream <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./ReadStream&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> rs <span class="token operator">=</span> <span class="token function">ReadStream</span><span class="token punctuation">(</span><span class="token string">&quot;./1.txt&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">flags</span><span class="token operator">:</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">&quot;utf8&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">highWaterMark</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> FileWriteStream <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./WriteStream&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> ws <span class="token operator">=</span> <span class="token function">FileWriteStream</span><span class="token punctuation">(</span><span class="token string">&quot;./2.txt&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">flags</span><span class="token operator">:</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">&quot;utf8&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">highWaterMark</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
rs<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>ws<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">ReadStream</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">pipe</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">dest</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;data&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> flag <span class="token operator">=</span> dest<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  dest<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;drain&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    dest<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token class-name">ReadStream</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">pause</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>flowing <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
<span class="token class-name">ReadStream</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">resume</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>flowing <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="_5-4-暂停模式"><a href="#_5-4-暂停模式" class="header-anchor">#</a> 5.4 暂停模式</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> ReadStream2 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./ReadStream2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> rs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadStream2</span><span class="token punctuation">(</span><span class="token string">&quot;./1.txt&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">start</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
  <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">&quot;utf8&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">highWaterMark</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;readable&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;readable&quot;</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;rs.buffer.length&quot;</span><span class="token punctuation">,</span> rs<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token keyword">let</span> d <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;rs.buffer.length&quot;</span><span class="token punctuation">,</span> rs<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;rs.buffer.length&quot;</span><span class="token punctuation">,</span> rs<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/zhoubichuan/web-node/edit/master/src/base/stack/9.stream.md" target="_blank" rel="noopener noreferrer">在github上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/8/8 15:51:09</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/web-node/base/stack/8.fs.html" class="prev">
        八.fs
      </a></span> <span class="next"><a href="/web-node/base/stack/10.cache.html">
        十.cache
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/web-node/assets/js/app.3aff489a.js" defer></script><script src="/web-node/assets/js/2.8ac8e006.js" defer></script><script src="/web-node/assets/js/52.5e6a67e8.js" defer></script><script src="/web-node/assets/js/6.64657bde.js" defer></script>
  </body>
</html>
